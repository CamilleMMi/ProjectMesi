
<!-- POST -->
<div>
    <check if="{{@post.picture}}">
        <true>
            <div class="p-4">
                <img src="../{{@post.picture}}" width="40%">
            </div>
        </true>
    </check>

    <div class="bg-light p-3 description_post">
        <div class="description_post_info">
            <h3>{{@post.title}}</h3>
            <p><img src="../{{@post.user.photo_profile}}" width="45" height="45"> Par <a href="/{{@post.user.pseudo}}/profil">{{@post.user.pseudo}}</a></p>
            <p>{{@post.description}}</p>
        </div>

        <hr>

        <small class="text-center">Posté le {{date('d/m/Y',strtotime(@post.post_date))}}</small>
        <div class="icons_post">
            <div class="icon"><b><i class="bi bi-heart-fill"></i> {{@post.like_amount}}</b> </div>
            <div class="icon"><b><i class="bi bi-eye-fill"></i> {{@post.view_amount}}</b></div>
            <div class="icon"><b><i class="bi bi-chat-dots-fill"></i> {{@post.view_amount}}</b></div>
        </div>
    </div>
</div>


<br><hr>


<!-- COMMENTAIRES -->
<form action="" class="form-group" method="POST" id="form">
    <div class="p-2">
        <div class="row">
            <div class="d-flex align-items-center justify-content-end col">
                <img src="../{{@USER.photo_profile}}" width="50">
            </div>
            <div class="col-11 text-left">
                <b>{{@USER.pseudo}}</b>
                <textarea id="body" name="body" class="form-control ml-1 shadow-none textarea"></textarea>
            </div>
        </div>
        <div class="mt-2 text-right">
            <button class="btn btn-success btn-sm shadow-none" type="submit">Envoyer</button>
        </div>
    </div>
</form>

<div id="status"></div>

<!-- Liste de tous les commentaires -->

<div id="liste_commentaires">
    <check if="{{@commentaires}}">
        <false><p><i>Aucun commentaire, Soyez le premier !</i></p></false>
        <true>
            <repeat group="{{ @commentaires }}" value="{{ @commentaire }}">
                <div class="p-2">
                    <div class="row">
                        <div class="d-flex align-items-center justify-content-end col">
                            <img src="../{{@commentaire.user.photo_profile}}" width="50" height="50">
                        </div>

                        <div class="col-11 text-left">
                            <b>{{@commentaire.user.pseudo}}</b>
                            <small>posté le {{ date('d/m/Y',strtotime(@commentaire.date))}}</small>
                            <p class="form-control w-100 shadow-none">{{@commentaire.body}}</p>
                        </div>
                    </div>
                    <div class="text-right">
                        <check if="{{@commentaire.user._id == @USER._id }}">
                            <true><button class="delete btn btn-danger btn-sm shadow-none" value="{{@commentaire._id}}">Supprimer</button></true>
                        </check>
                    </div>
                </div>
            </repeat>
        </true>
    </check>
</div>

<script>
    const form = document.getElementById("form");
    const status = document.getElementById("status");

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formdata = new FormData(form);

        const fetchOperations = async() => {
            status.innerHTML = `<i style="color: blue">En cours...</i>`;

            let response = await fetch('/post/' + {{@post._id}} + '/send_comment',
                {
                    method: 'POST',
                    body: formdata
                });
            if (response.ok) {
                status.innerHTML = `<b style="color: green">Post crées !</b>`;
                console.log(response.url);
                window.location.href = response.url;
            }
            else { console.log(response.status); }
        }
        fetchOperations();
    })

    buttons_delete = document.getElementsByClassName("delete");
    for(let i = 0 ; i < buttons_delete.length ; i++) {
        buttons_delete[i].addEventListener("click", function() {
            console.log("hey!!");
            //Bootbox pour confirmer
            bootbox.confirm({
                title: 'Êtes-vous sûr de supprimer votre commentaire ?',
                message: 'Vous ne pouvez pas revenir en arrière si vous confirmer',
                callback: function (result) {
                    if(result==true){
                        $.ajax({
                            url:'/post/delete_comment',
                            data:{commentaire_id: buttons_delete[i].value},
                            type:'POST',
                            success: function(data) {
                                buttons_delete[i].parentNode.innerHTML = `SUPPRIMER`;
                            }
                        });
                    }
                    console.log(result);
                }
            });
        })
    }
</script>

