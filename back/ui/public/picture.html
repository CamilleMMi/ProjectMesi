<check if="{{@post.picture}}">
    <true><img src="../{{@post.picture}}"></true>
</check>

<h1>Post N°<span id="post_id">{{@post._id}}</span></h1>

<fieldset>
    <legend><h3>{{@post.title}}</h3></legend>
    <p>{{@post.description}}</p>

    <hr>

    <br>
    <small><i>Posté le {{date('d/m/Y',strtotime(@post.post_date))}}</i></small>
</fieldset>

<br>
<b>Like : {{@post.like_amount}}</b> | <b>Vues : {{@post.view_amount}}</b>

<br><hr>

<h2>Commentaires</h2>
<form action="" class="form-group" method="POST" id="form">
    [pseudo]
    <label for="body">Commentaire</label>
    <textarea class="form-control" id="body" name="body" rows="5" cols="33">Ecrire un commentaire</textarea>
    <button class="btn btn-success" type="submit">Envoyer</button>
</form>

<div id="status"></div>

<hr>

<!-- Liste de tous les commentaires -->

<div id="liste_commentaires">
    <repeat group="{{ @commentaires }}" value="{{ @commentaire }}">
        <div class="form-group">
            <b>{{@commentaire.user.pseudo}}</b>
            <p class="form-control" id="body" name="body" rows="5" cols="33">{{@commentaire.body}}</p>
            <small>posté le {{ date('d/m/Y',strtotime(@commentaire.date))}}</small>
            <check if="{{@commentaire.user._id == @USER._id }}">
                <true><button class="delete btn btn-danger" value="{{@commentaire._id}}"><i class="bi bi-trash3-fill"></i></button></true>
            </check>
        </div>
    </repeat>
</div>

<script>
    const form = document.getElementById("form");
    const status = document.getElementById("status");

    form.addEventListener('submit', function(e) {
        e.preventDefault();

        const formdata = new FormData(form);

        const fetchOperations = async() => {
            status.innerHTML = `<i style="color: blue">En cours...</i>`;

            let response = await fetch('/post/' + document.getElementById("post_id").textContent + '/send_comment',
                {
                    method: 'POST',
                    body: formdata
                });
            if (response.ok) {
                status.innerHTML = `<b style="color: green">Post crées !</b>`;
                console.log(response.url);
                window.location.href = response.url;
            }
            else { console.log(response.status); }
        }
        fetchOperations();
    })

    buttons_delete = document.getElementsByClassName("delete");
    for(let i = 0 ; i < buttons_delete.length ; i++) {
        buttons_delete[i].addEventListener("click", function() {
            //Utiliser bootbox pour confirmer
            console.log("hey!!");
        })
    }
</script>

